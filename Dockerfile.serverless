# ---------------------------------------------------------------------------
# Dockerfile.serverless – RunPod Serverless image for Qwen3-TTS Studio
#
# Full podcast pipeline: LLM → outline → transcript → TTS → combined audio
#
# Build:
#   docker build -f Dockerfile.serverless -t qwen3-tts-serverless .
# ---------------------------------------------------------------------------

FROM python:3.12-slim AS builder

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /build

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

COPY . /build

RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

RUN pip install --upgrade pip && \
    pip install "qwen-tts>=0.1.1,<0.2" && \
    pip install soundfile numpy packaging pydantic && \
    pip install runpod && \
    pip install boto3 && \
    pip install pydub && \
    pip install moviepy && \
    pip install openai anthropic

# ---------------------------------------------------------------------------
# Final stage: runtime
# ---------------------------------------------------------------------------
FROM python:3.12-slim

LABEL org.opencontainers.image.title="Qwen3-TTS Studio Serverless" \
      org.opencontainers.image.description="RunPod Serverless: full podcast pipeline (LLM + TTS)" \
      org.opencontainers.image.version="0.2.0"

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/venv/bin:$PATH" \
    QWEN_TTS_MODEL_DIR="/models"

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    libsndfile1 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/* || true

COPY --from=builder /opt/venv /opt/venv

# Copy ALL modules needed for the full pipeline
COPY audio/           /app/audio/
COPY podcast/         /app/podcast/
COPY storage/         /app/storage/
COPY config.py        /app/config.py
COPY handler.py       /app/handler.py

CMD ["python", "-u", "handler.py"]
